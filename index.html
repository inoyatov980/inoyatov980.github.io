<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RubArkanoid Pro</title>
    
    <!-- SDK Telegram –∏ Adsgram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        /* --- –î–ò–ó–ê–ô–ù –°–ò–°–¢–ï–ú–ê --- */
        :root {
            --bg: #000000;
            --card-bg: #1c1c1e;
            --gold: #ffcc00;
            --text-main: #ffffff;
            --text-sec: #8e8e93;
            --green: #34c759;
            --blue: #007aff;
            --red: #ff3b30;
            --btn-grad: linear-gradient(180deg, #ffcc00 0%, #ff9500 100%);
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- –®–ê–ü–ö–ê --- */
        .header {
            padding: 12px 20px;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-rank { font-size: 11px; color: var(--gold); text-transform: uppercase; margin-top: 2px; }
        
        .stats-block { 
            display: flex;
            gap: 20px;
            text-align: center;
        }
        .stat-item { display: flex; flex-direction: column; }
        .stat-value { font-size: 18px; font-weight: 800; color: #fff; line-height: 1; }
        .stat-label { font-size: 10px; color: var(--text-sec); font-weight: 500; margin-top: 2px; }
        
        /* --- –ò–ì–†–û–í–û–ï –ü–û–õ–ï --- */
        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: linear-gradient(to bottom, #0a0a0a, #1a1a1a);
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: block;
        }
        
        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }
        
        .game-title {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(45deg, #ffcc00, #ff9500);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .game-subtitle {
            font-size: 14px;
            color: var(--text-sec);
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
        }
        
        .btn-start {
            padding: 16px 40px;
            border-radius: 16px;
            border: none;
            background: var(--btn-grad);
            color: #000;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 204, 0, 0.3);
            transition: transform 0.2s;
        }
        
        .btn-start:active {
            transform: scale(0.95);
        }
        
        .level-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .restart-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 59, 48, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3;
            border: 1px solid #ff3b30;
            color: #ff3b30;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .coin-indicator {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .upgrade-btn {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 199, 89, 0.3);
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 28px;
            z-index: 3;
            border: 2px solid #34c759;
            color: #34c759;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
        }

        /* --- –ë–ê–ù–ù–ï–†–ù–ê–Ø –†–ï–ö–õ–ê–ú–ê --- */
        .banner-ad {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 50px;
            background: #252528;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            border-top: 1px solid #333;
        }
        
        .ad-text {
            font-size: 12px;
            color: var(--text-sec);
            text-align: center;
            padding: 0 20px;
        }
        
        .ad-btn {
            background: var(--blue);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            cursor: pointer;
        }

        /* --- –í–°–ü–õ–´–í–ê–Æ–©–ï–ï –û–ö–ù–û –ü–û–°–õ–ï –ò–ì–†–´ --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .popup-box {
            background: #1c1c1e;
            width: 85%;
            max-width: 320px;
            border-radius: 20px;
            padding: 25px;
            border: 1px solid #444;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            text-align: center;
        }
        
        .popup-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--gold);
        }
        
        .popup-subtitle {
            font-size: 14px;
            color: var(--text-sec);
            margin-bottom: 25px;
        }
        
        .popup-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            padding: 15px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        
        .popup-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .popup-stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--gold);
        }
        
        .popup-stat-label {
            font-size: 11px;
            color: var(--text-sec);
            margin-top: 5px;
        }
        
        .popup-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-popup {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-popup:active {
            transform: scale(0.95);
        }
        
        .btn-restart-ad {
            background: var(--blue);
            color: white;
        }
        
        .btn-restart {
            background: #333;
            color: white;
        }

    </style>
</head>
<body>

    <!-- –®–ê–ü–ö–ê -->
    <div class="header">
        <div class="user-info">
            <span class="user-name" id="username">–ò–≥—Ä–æ–∫</span>
            <span class="user-rank" id="rank">–ù–æ–≤–∏—á–æ–∫</span>
        </div>
        <div class="stats-block">
            <div class="stat-item">
                <div class="stat-value" id="balance">0</div>
                <div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highScore">0</div>
                <div class="stat-label">–†–µ–∫–æ—Ä–¥</div>
            </div>
        </div>
    </div>

    <!-- –ò–ì–†–û–í–û–ï –ü–û–õ–ï -->
    <div class="game-area">
        <canvas id="gameCanvas"></canvas>
        
        <div class="level-indicator" id="levelIndicator" style="opacity: 0;">üéÆ –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">1</span></div>
        <div class="restart-btn" id="restartBtn" onclick="restartGameWithAd()" style="opacity: 0;">üîÑ –ó–∞–Ω–æ–≤–æ</div>
        <div class="coin-indicator" id="coinIndicator" style="opacity: 0;">ü™ô <span id="gameCoins">0</span></div>
        <div class="upgrade-btn" id="upgradeBtn" onclick="showRewardForUpgrade()" style="opacity: 0;">‚ú®</div>
        
        <!-- –ë–ê–ù–ù–ï–†–ù–ê–Ø –†–ï–ö–õ–ê–ú–ê -->
        <div class="banner-ad" id="bannerAd" style="opacity: 0;">
            <div class="ad-text">–°–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ +500 –º–æ–Ω–µ—Ç!</div>
            <button class="ad-btn" onclick="showBannerAd()">–°–º–æ—Ç—Ä–µ—Ç—å</button>
        </div>
        
        <div id="startScreen" class="game-overlay">
            <div class="game-title">RUB ARKANOID</div>
            <div class="game-subtitle">–†–∞–∑–±–∏–≤–∞–π—Ç–µ –±–ª–æ–∫–∏, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –º–æ–Ω–µ—Ç—ã!</div>
            <button class="btn-start" id="startBtn">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
        </div>
    </div>

    <!-- –í–°–ü–õ–´–í–ê–Æ–©–ï–ï –û–ö–ù–û –ü–û–°–õ–ï –ò–ì–†–´ -->
    <div id="gameOverPopup" class="popup-overlay">
        <div class="popup-box">
            <div class="popup-title" id="popupTitle">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</div>
            <div class="popup-subtitle" id="popupSubtitle">–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –º–æ–Ω–µ—Ç—ã</div>
            
            <div class="popup-stats">
                <div class="popup-stat">
                    <div class="popup-stat-value" id="popupCoins">0</div>
                    <div class="popup-stat-label">–ú–æ–Ω–µ—Ç—ã</div>
                </div>
                <div class="popup-stat">
                    <div class="popup-stat-value" id="popupScore">0</div>
                    <div class="popup-stat-label">–°—á–µ—Ç</div>
                </div>
                <div class="popup-stat">
                    <div class="popup-stat-value" id="popupLevel">1</div>
                    <div class="popup-stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                </div>
            </div>
            
            <div class="popup-actions">
                <button class="btn-popup btn-restart" onclick="restartGame()">–ò–≥—Ä–∞—Ç—å</button>
                <button class="btn-popup btn-restart-ad" onclick="restartWithRewardedAd()">+500 –º–æ–Ω–µ—Ç üé•</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        const tg = window.Telegram.WebApp;
        if (tg) {
            tg.expand();
            tg.setHeaderColor('#000000');
            tg.setBackgroundColor('#000000');
        }

        const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
        if (user) {
            document.getElementById('username').innerText = user.first_name || '–ò–≥—Ä–æ–∫';
        }

        // --- 2. –ë–ê–õ–ê–ù–° –ò –õ–û–ì–ò–ö–ê ---
        let balance = parseInt(localStorage.getItem('rubarkanoid_bal')) || 0;
        let highScore = parseInt(localStorage.getItem('rubarkanoid_hs')) || 0;
        let ballUpgradeLevel = parseInt(localStorage.getItem('rubarkanoid_upgrade')) || 1;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const elBal = document.getElementById('balance');
        const elRank = document.getElementById('rank');
        const elHighScore = document.getElementById('highScore');

        updateUI();

        function addCoins(n) {
            balance += n;
            saveAndUpd();
        }

        function saveAndUpd() {
            localStorage.setItem('rubarkanoid_bal', balance);
            localStorage.setItem('rubarkanoid_hs', highScore);
            localStorage.setItem('rubarkanoid_upgrade', ballUpgradeLevel);
            updateUI();
        }

        function updateUI() {
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
            elBal.innerText = balance.toLocaleString();
            elHighScore.innerText = highScore.toLocaleString();
            
            // –°–∏—Å—Ç–µ–º–∞ –∑–≤–∞–Ω–∏–π
            if (balance < 5000) elRank.innerText = "–ù–æ–≤–∏—á–æ–∫";
            else if (balance < 20000) elRank.innerText = "–õ—é–±–∏—Ç–µ–ª—å";
            else if (balance < 100000) elRank.innerText = "–ú–∞–≥–Ω–∞—Ç";
            else elRank.innerText = "–û–ª–∏–≥–∞—Ä—Ö";
            elRank.style.color = (balance > 20000) ? "#34c759" : "#ffcc00";
        }

        // --- 3. –ò–ì–†–ê –ê–†–ö–ê–ù–û–ò–î ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const gameOverPopup = document.getElementById('gameOverPopup');
        
        // –ò–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const levelIndicator = document.getElementById('levelIndicator');
        const restartBtn = document.getElementById('restartBtn');
        const coinIndicator = document.getElementById('coinIndicator');
        const upgradeBtn = document.getElementById('upgradeBtn');
        const bannerAd = document.getElementById('bannerAd');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ø–∞–ø–∞
        const popupTitle = document.getElementById('popupTitle');
        const popupSubtitle = document.getElementById('popupSubtitle');
        const popupCoins = document.getElementById('popupCoins');
        const popupScore = document.getElementById('popupScore');
        const popupLevel = document.getElementById('popupLevel');
        
        let gameActive = false;
        let gameCoins = 0;
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        
        // –†–∞–∑–º–µ—Ä—ã –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        let canvasWidth, canvasHeight;
        const paddleHeight = 20;
        const paddleWidth = 120;
        const ballRadius = 12;
        const brickRowCount = 3;
        const brickColumnCount = 7;
        const brickWidth = 70;
        const brickHeight = 25;
        const brickPadding = 8;
        const brickOffsetTop = 90;
        const brickOffsetLeft = 10;
        
        let paddleX;
        let ballX, ballY;
        let ballSpeedX, ballSpeedY;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –º—è—á–∞
        function getBallSpeed() {
            return 5 + (ballUpgradeLevel - 1) * 0.8;
        }
        
        // –ë–ª–æ–∫–∏
        let bricks = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–ª–æ–∫–æ–≤
        function initBricks() {
            bricks = [];
            for (let c = 0; c < brickColumnCount; c++) {
                bricks[c] = [];
                for (let r = 0; r < brickRowCount; r++) {
                    const colors = ['#ff3b30', '#ff9500', '#ffcc00'];
                    bricks[c][r] = { 
                        x: 0, 
                        y: 0, 
                        status: 1,
                        color: colors[r % colors.length],
                        value: (r + 1) * 15
                    };
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
        let isDragging = false;
        
        function handleTouchStart(e) {
            e.preventDefault();
            isDragging = true;
            updatePaddlePosition(e.touches[0]);
        }
        
        function handleTouchMove(e) {
            if (!gameActive || !isDragging) return;
            e.preventDefault();
            updatePaddlePosition(e.touches[0]);
        }
        
        function handleTouchEnd() {
            isDragging = false;
        }
        
        function handleMouseMove(e) {
            if (!gameActive) return;
            updatePaddlePosition(e);
        }
        
        function updatePaddlePosition(event) {
            const rect = canvas.getBoundingClientRect();
            let relativeX = event.clientX - rect.left;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            relativeX = Math.max(paddleWidth/2, Math.min(canvasWidth - paddleWidth/2, relativeX));
            paddleX = relativeX - paddleWidth/2;
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–Ω–≤–∞—Å–∞
        function resizeCanvas() {
            const gameArea = document.querySelector('.game-area');
            canvasWidth = gameArea.clientWidth;
            canvasHeight = gameArea.clientHeight;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤–Ω–∏–∑—É, —Å –æ—Ç—Å—Ç—É–ø–æ–º –æ—Ç –∫—Ä–∞—è
            paddleX = (canvasWidth - paddleWidth) / 2;
            
            console.log("Canvas —Ä–∞–∑–º–µ—Ä—ã:", canvasWidth, canvasHeight);
        }
        
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        function drawPaddle() {
            // –ü–æ–∑–∏—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –í–ù–ò–ó–£ —ç–∫—Ä–∞–Ω–∞ —Å –æ—Ç—Å—Ç—É–ø–æ–º
            const paddleY = canvasHeight - paddleHeight - 40; // –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø
            
            // –¢–µ–Ω—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            ctx.shadowColor = 'rgba(0, 122, 255, 0.7)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            
            // –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            ctx.beginPath();
            ctx.roundRect(paddleX, paddleY, paddleWidth, paddleHeight, 12);
            
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            const gradient = ctx.createLinearGradient(
                paddleX, paddleY, 
                paddleX, paddleY + paddleHeight
            );
            gradient.addColorStop(0, '#007aff');
            gradient.addColorStop(0.5, '#0055ff');
            gradient.addColorStop(1, '#0033cc');
            
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.closePath();
            
            // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
            ctx.shadowColor = 'transparent';
            
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            ctx.beginPath();
            ctx.moveTo(paddleX + paddleWidth/2, paddleY + 3);
            ctx.lineTo(paddleX + paddleWidth/2, paddleY + paddleHeight - 3);
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();
            
            // –ö—Ä–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –æ–±—ä–µ–º–∞
            ctx.beginPath();
            ctx.roundRect(paddleX, paddleY, paddleWidth, paddleHeight, 12);
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();
            
            console.log("–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞:", paddleX, paddleY, paddleWidth, paddleHeight);
        }
        
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º—è—á–∞
        function drawBall() {
            // –¢–µ–Ω—å –º—è—á–∞
            ctx.shadowColor = 'rgba(255, 204, 0, 0.6)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            
            ctx.beginPath();
            ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
            
            if (ballUpgradeLevel > 1) {
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –º—è—á–∞
                const gradient = ctx.createRadialGradient(
                    ballX, ballY, 0,
                    ballX, ballY, ballRadius
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(0.5, '#ffcc00');
                gradient.addColorStop(1, '#ff9500');
                ctx.fillStyle = gradient;
            } else {
                // –ü—Ä–æ—Å—Ç–æ–π –∂–µ–ª—Ç—ã–π –º—è—á
                const gradient = ctx.createRadialGradient(
                    ballX, ballY, 0,
                    ballX, ballY, ballRadius
                );
                gradient.addColorStop(0, '#ffeb3b');
                gradient.addColorStop(1, '#ff9800');
                ctx.fillStyle = gradient;
            }
            
            ctx.fill();
            ctx.closePath();
            
            // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
            ctx.shadowColor = 'transparent';
        }
        
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤
        function drawBricks() {
            for (let c = 0; c < brickColumnCount; c++) {
                for (let r = 0; r < brickRowCount; r++) {
                    if (bricks[c][r].status === 1) {
                        const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                        const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                        bricks[c][r].x = brickX;
                        bricks[c][r].y = brickY;
                        
                        // –¢–µ–Ω—å –±–ª–æ–∫–∞
                        ctx.shadowColor = 'rgba(0,0,0,0.4)';
                        ctx.shadowBlur = 8;
                        ctx.shadowOffsetX = 3;
                        ctx.shadowOffsetY = 3;
                        
                        // –°–∞–º –±–ª–æ–∫
                        ctx.beginPath();
                        ctx.roundRect(brickX, brickY, brickWidth, brickHeight, 6);
                        ctx.fillStyle = bricks[c][r].color;
                        ctx.fill();
                        ctx.closePath();
                        
                        // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
                        ctx.shadowColor = 'transparent';
                        
                        // –û–±–≤–æ–¥–∫–∞ –±–ª–æ–∫–∞
                        ctx.beginPath();
                        ctx.roundRect(brickX, brickY, brickWidth, brickHeight, 6);
                        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        ctx.closePath();
                    }
                }
            }
        }
        
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function drawUI() {
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`‚ù§Ô∏è ${lives}`, 20, 40);
            
            ctx.textAlign = 'right';
            ctx.fillText(`üéØ ${score}`, canvasWidth - 20, 40);
            
            ctx.textAlign = 'center';
            ctx.fillText(`ü™ô ${gameCoins}`, canvasWidth / 2, 40);
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∂–∏–∑–Ω–µ–π
            if (lives > 0) {
                const barWidth = 60;
                const barHeight = 8;
                const barX = 20;
                const barY = 50;
                
                // –§–æ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                ctx.fillStyle = lives >= 3 ? '#34c759' : lives === 2 ? '#ffcc00' : '#ff3b30';
                ctx.fillRect(barX, barY, barWidth * (lives / 3), barHeight);
            }
        }
        
        // –°–±—Ä–æ—Å –º—è—á–∞
        function resetBall() {
            ballX = canvasWidth / 2;
            ballY = canvasHeight - 120; // –°—Ç–∞—Ä—Ç –≤—ã—à–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            const speed = getBallSpeed();
            ballSpeedX = speed * (Math.random() > 0.5 ? 1 : -1);
            ballSpeedY = -speed;
        }
        
        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–≥—Ä—ã
        function gameLoop() {
            if (!gameActive) return;
            
            // –û—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–≤–∞—Å–∞
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // –†–∏—Å—É–µ–º —Ñ–æ–Ω
            const gradient = ctx.createLinearGradient(0, 0, 0, canvasHeight);
            gradient.addColorStop(0, '#0a0a0a');
            gradient.addColorStop(1, '#1a1a1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            drawBricks();
            drawBall();
            drawPaddle(); // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∏—Å—É–µ—Ç—Å—è –ü–û–°–õ–ï–î–ù–ï–ô —á—Ç–æ–±—ã –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
            drawUI();
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –º—è—á–∞
            ballX += ballSpeedX;
            ballY += ballSpeedY;
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–Ω–∞–º–∏
            if (ballX + ballRadius > canvasWidth || ballX - ballRadius < 0) {
                ballSpeedX = -ballSpeedX;
                // –í–∏–±—Ä–∞—Ü–∏—è
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('soft');
                }
            }
            
            if (ballY - ballRadius < 0) {
                ballSpeedY = -ballSpeedY;
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('soft');
                }
            }
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
            const paddleY = canvasHeight - paddleHeight - 40;
            
            if (
                ballY + ballRadius > paddleY &&
                ballY - ballRadius < paddleY + paddleHeight &&
                ballX > paddleX &&
                ballX < paddleX + paddleWidth
            ) {
                // –£–≥–æ–ª –æ—Ç—Å–∫–æ–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∫—É–¥–∞ –ø–æ–ø–∞–ª –º—è—á
                const hitPoint = (ballX - (paddleX + paddleWidth / 2)) / (paddleWidth / 2);
                ballSpeedX = hitPoint * 7;
                ballSpeedY = -Math.abs(ballSpeedY);
                
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –º—è—á–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å—Ç—Ä—è–ª –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
                ballY = paddleY - ballRadius;
                
                // –í–∏–±—Ä–∞—Ü–∏—è
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
                
                // –ë–æ–Ω—É—Å –∑–∞ –æ—Ç—Å–∫–æ–∫
                gameCoins += 1;
                document.getElementById('gameCoins').innerText = gameCoins;
            }
            
            // –ü—Ä–æ–∏–≥—Ä—ã—à (–º—è—á —É–ø–∞–ª)
            if (ballY - ballRadius > canvasHeight) {
                lives--;
                if (lives <= 0) {
                    gameOver(false);
                    return;
                } else {
                    resetBall();
                    if (tg && tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('medium');
                    }
                }
            }
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –±–ª–æ–∫–∞–º–∏
            for (let c = 0; c < brickColumnCount; c++) {
                for (let r = 0; r < brickRowCount; r++) {
                    const brick = bricks[c][r];
                    if (brick.status === 1) {
                        if (
                            ballX > brick.x &&
                            ballX < brick.x + brickWidth &&
                            ballY > brick.y &&
                            ballY < brick.y + brickHeight
                        ) {
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å –∫–∞–∫–æ–π —Å—Ç–æ—Ä–æ–Ω—ã —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ
                            const ballLeft = ballX - ballRadius;
                            const ballRight = ballX + ballRadius;
                            const ballTop = ballY - ballRadius;
                            const ballBottom = ballY + ballRadius;
                            
                            const brickLeft = brick.x;
                            const brickRight = brick.x + brickWidth;
                            const brickTop = brick.y;
                            const brickBottom = brick.y + brickHeight;
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å–∫–æ–∫–∞
                            const fromLeft = ballRight - brickLeft;
                            const fromRight = brickRight - ballLeft;
                            const fromTop = ballBottom - brickTop;
                            const fromBottom = brickBottom - ballTop;
                            
                            // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ
                            const minX = Math.min(fromLeft, fromRight);
                            const minY = Math.min(fromTop, fromBottom);
                            
                            if (minX < minY) {
                                ballSpeedX = -ballSpeedX;
                            } else {
                                ballSpeedY = -ballSpeedY;
                            }
                            
                            brick.status = 0;
                            score += brick.value;
                            
                            gameCoins += brick.value;
                            document.getElementById('gameCoins').innerText = gameCoins;
                            
                            if (tg && tg.HapticFeedback) {
                                tg.HapticFeedback.impactOccurred('light');
                            }
                        }
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
            let allDestroyed = true;
            for (let c = 0; c < brickColumnCount; c++) {
                for (let r = 0; r < brickRowCount; r++) {
                    if (bricks[c][r].status === 1) allDestroyed = false;
                }
            }
            
            if (allDestroyed) {
                levelComplete();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
        function levelComplete() {
            const levelBonus = 150 * currentLevel;
            gameCoins += levelBonus;
            document.getElementById('gameCoins').innerText = gameCoins;
            
            currentLevel++;
            document.getElementById('currentLevel').innerText = currentLevel;
            
            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
            const speedIncrease = 1.1;
            ballSpeedX *= speedIncrease;
            ballSpeedY *= speedIncrease;
            
            resetBall();
            initBricks();
            
            if (tg) {
                tg.showAlert(`üéâ –£—Ä–æ–≤–µ–Ω—å ${currentLevel-1} –ø—Ä–æ–π–¥–µ–Ω! +${levelBonus} –º–æ–Ω–µ—Ç`);
            }
        }
        
        // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
        function gameOver(isWin) {
            gameActive = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥
            if (score > highScore) {
                highScore = score;
            }
            
            // –ù–∞—á–∏—Å–ª—è–µ–º –º–æ–Ω–µ—Ç—ã
            const totalEarned = gameCoins;
            addCoins(totalEarned);
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å –∏–≥—Ä–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            levelIndicator.style.opacity = '0';
            restartBtn.style.opacity = '0';
            coinIndicator.style.opacity = '0';
            upgradeBtn.style.opacity = '0';
            bannerAd.style.opacity = '0';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
            showGameOverPopup(isWin, totalEarned);
            
            // –í–∏–±—Ä–∞—Ü–∏—è
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ø–∞–ø –ø–æ—Å–ª–µ –∏–≥—Ä—ã
        function showGameOverPopup(isWin, earnedCoins) {
            popupTitle.innerText = isWin ? "üéâ –ü–û–ë–ï–î–ê!" : "üíÄ –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê";
            popupSubtitle.innerText = isWin ? 
                `–í—ã –ø—Ä–æ—à–ª–∏ —É—Ä–æ–≤–µ–Ω—å ${currentLevel}!` : 
                `–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${earnedCoins} –º–æ–Ω–µ—Ç`;
            popupCoins.innerText = earnedCoins;
            popupScore.innerText = score;
            popupLevel.innerText = currentLevel;
            
            gameOverPopup.style.display = 'flex';
        }
        
        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
        function startGame() {
            console.log("–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...");
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
            startScreen.style.display = 'none';
            gameOverPopup.style.display = 'none';
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å –∏–≥—Ä–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            levelIndicator.style.opacity = '1';
            restartBtn.style.opacity = '1';
            coinIndicator.style.opacity = '1';
            upgradeBtn.style.opacity = '1';
            bannerAd.style.opacity = '1';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
            resizeCanvas();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            gameActive = true;
            score = 0;
            lives = 3;
            gameCoins = 0;
            currentLevel = 1;
            
            document.getElementById('gameCoins').innerText = gameCoins;
            document.getElementById('currentLevel').innerText = currentLevel;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            resetBall();
            initBricks();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            canvas.addEventListener('mousemove', handleMouseMove);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            console.log("–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞! –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞");
            gameLoop();
        }
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        function restartGame() {
            console.log("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã");
            gameOverPopup.style.display = 'none';
            startGame();
        }
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å —Ä–µ–∫–ª–∞–º–æ–π
        function restartWithRewardedAd() {
            console.log("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å —Ä–µ–∫–ª–∞–º–æ–π");
            
            if (window.Adsgram) {
                const AdController = window.Adsgram.init({ blockId: "21603", debug: true });
                AdController.show().then((result) => {
                    if (result.done) {
                        addCoins(500);
                        if (tg) tg.showAlert("+500 –º–æ–Ω–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ!");
                        restartGame();
                    }
                }).catch((error) => {
                    console.log("–û—à–∏–±–∫–∞ —Ä–µ–∫–ª–∞–º—ã:", error);
                    restartGame();
                });
            } else {
                console.log("Adsgram –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
                restartGame();
            }
        }
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ó–∞–Ω–æ–≤–æ"
        function restartGameWithAd() {
            console.log("–ö–Ω–æ–ø–∫–∞ '–ó–∞–Ω–æ–≤–æ' –Ω–∞–∂–∞—Ç–∞");
            
            if (gameActive) {
                if (confirm("–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É?")) {
                    if (window.Adsgram) {
                        const AdController = window.Adsgram.init({ blockId: "21603", debug: true });
                        AdController.show().then((result) => {
                            if (result.done) {
                                addCoins(300);
                                if (tg) tg.showAlert("+300 –º–æ–Ω–µ—Ç –∑–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫!");
                                gameOver(false);
                            }
                        }).catch((error) => {
                            console.log("–û—à–∏–±–∫–∞ —Ä–µ–∫–ª–∞–º—ã:", error);
                            gameOver(false);
                        });
                    } else {
                        gameOver(false);
                    }
                }
            } else {
                startGame();
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–∏–µ –º—è—á–∞
        function showRewardForUpgrade() {
            console.log("–£–ª—É—á—à–µ–Ω–∏–µ –º—è—á–∞");
            
            if (window.Adsgram) {
                const AdController = window.Adsgram.init({ blockId: "21603", debug: true });
                AdController.show().then((result) => {
                    if (result.done) {
                        ballUpgradeLevel++;
                        addCoins(200);
                        saveAndUpd();
                        if (tg) tg.showAlert(`‚ú® –ú—è—á —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${ballUpgradeLevel}! +200 –º–æ–Ω–µ—Ç`);
                        
                        if (gameActive) {
                            const speed = getBallSpeed();
                            const ratioX = ballSpeedX / Math.abs(ballSpeedX);
                            const ratioY = ballSpeedY / Math.abs(ballSpeedY);
                            ballSpeedX = speed * ratioX;
                            ballSpeedY = speed * ratioY;
                        }
                    }
                }).catch((error) => {
                    console.log("–û—à–∏–±–∫–∞ —Ä–µ–∫–ª–∞–º—ã:", error);
                });
            }
        }
        
        // –ë–∞–Ω–Ω–µ—Ä–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞
        function showBannerAd() {
            console.log("–ë–∞–Ω–Ω–µ—Ä–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞");
            
            if (window.Adsgram) {
                const AdController = window.Adsgram.init({ blockId: "21603", debug: true });
                AdController.show().then((result) => {
                    if (result.done) {
                        addCoins(500);
                        if (tg) tg.showAlert("+500 –º–æ–Ω–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ!");
                    }
                }).catch((error) => {
                    console.log("–û—à–∏–±–∫–∞ —Ä–µ–∫–ª–∞–º—ã:", error);
                });
            }
        }

        // --- 4. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
        window.addEventListener('load', function() {
            console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç–∞
            startBtn.addEventListener('click', startGame);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É roundRect
            if (!CanvasRenderingContext2D.prototype.roundRect) {
                CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
                    if (w < 2 * r) r = w / 2;
                    if (h < 2 * r) r = h / 2;
                    this.beginPath();
                    this.moveTo(x + r, y);
                    this.arcTo(x + w, y, x + w, y + h, r);
                    this.arcTo(x + w, y + h, x, y + h, r);
                    this.arcTo(x, y + h, x, y, r);
                    this.arcTo(x, y, x + w, y, r);
                    this.closePath();
                    return this;
                };
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
            updateUI();
        });

    </script>
</body>
</html>
